<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Canvas Example</title>
  </head>
  <body>
    <canvas id="myCanvas"></canvas>

    <script>
      const slotWidth = 150;
      const slotHeight = 150;
      const slotSpacing = 25;
      const width = slotWidth*6 + slotSpacing*4;
      const height = slotHeight*2;
      const n_slow = 5; // how many fruits before stop

      var canvas = document.getElementById('myCanvas');
      var context = canvas.getContext('2d');
      context.canvas.width  = width;
      context.canvas.height = height;

      function getRandomInt(max) {
          return Math.floor(Math.random() * max);
      }

      function slotColumn(startX, startY, winningNumber, length){
        this.startX = startX;
        this.startY = startY;
        this.x = startX;
        this.y = startY;
        this.winningNumber = winningNumber;
        this.lengthOfWheel = length;
        this.symbols = ['üçí', 'üçã', 'üçä', 'üçâ', 'üçá', 'üçì', '‚≠ê', 'üîî', 'ü§†', 'ü§§'];
        this.roller = [];
        this.speed = 20;
        this.current = 0;
        this.interval;
        this.init = function() {
          context.font = '100px Arial';
          for(var i = 0; i < this.lengthOfWheel; i++){
            this.roller.push(this.symbols[getRandomInt(this.symbols.length)]);
          };
          this.roller.push(this.symbols[this.winningNumber]);
          this.roller.push(this.symbols[getRandomInt(this.symbols.length)]);

        }

        this.reset = function() {
          this.roller = [];
          this.x = this.startX;
          this.y = this.startY;
          this.init();
        }

        this.update = function() {
          // Clear the specific slot area to avoid ghosting
          context.clearRect(this.x, 0, slotWidth, height);
          this.y = this.y + this.speed;
          //slowdown effect
          const stop_const = Math.floor(this.y - this.startY - slotHeight*((this.lengthOfWheel+1)-n_slow)-40);
          if (stop_const > 0 && stop_const < (n_slow+1)*slotHeight){
            this.speed = Math.max( (1-Math.floor(stop_const/slotHeight)/n_slow)*20,0);
          }
          //spinning of wheel
          for (var i = 0; i <= this.lengthOfWheel+1; i++) {
            context.fillText(this.roller[i], this.x, this.y - slotHeight * i);
          }

          if (this.speed == 0) {
            clearInterval(this.interval);
          }
        }

        
        this.spin = function() {
          this.interval = setInterval(() => {
            this.update();
          }, 10);
          console.log(this.interval);
        }

        this.init();
      }


      function slotMachine(){
        this.res = [2,0,1];
        this.slot1 = new slotColumn(slotWidth*3, 0, this.res[0], 50);
        this.slot2 = new slotColumn(slotWidth*4, 0, this.res[1], 65);
        this.slot3 = new slotColumn(slotWidth*5, 0, this.res[2], 80);
        this.cols = [this.slot1, this.slot2, this.slot3];
        this.interval;

        this.it = function(func) {
          this.cols.forEach((item, index) => {
            item[func]();
          });
        }
        
        this.result = function() {
          // do something
          console.log(this.res);
          console.log(
            this.slot1.symbols[this.slot1.winningNumber],
            this.slot1.symbols[this.slot2.winningNumber],
            this.slot1.symbols[this.slot3.winningNumber]
          );
        };

        this.reset = function() {
          clearInterval(this.interval);
          this.it("reset");
        };

        this.spin = function() {
          this.it("spin");
          this.result();
        };


      };

      let slotmachine1 = new slotMachine();
      let slotmachine2 = new slotMachine();

      document.addEventListener('keydown', function(event) {
        if (event.code === 'Space'){
          //reset the screen when pressing
          slotmachine1.reset();
          slotmachine1.spin();
        } else if(event.code === 'ArrowUp'){
          slotmachine2.reset();
          slotmachine2.spin();
        };
      });
    </script>
  </body>
</html>
