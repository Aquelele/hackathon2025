<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Canvas Example</title>
  </head>
  <body>
    <canvas id="myCanvas"></canvas>

    <script>
      const slotWidth = 150;
      const slotHeight = 150;
      const slotSpacing = 25;
      const width = slotWidth*6 + slotSpacing*4;
      const height = slotHeight*2;

      var canvas = document.getElementById('myCanvas');
      var context = canvas.getContext('2d');
      context.canvas.width  = width;
      context.canvas.height = height;

      function getRandomInt(max) {
          return Math.floor(Math.random() * max);
      }

      function slotColumn(startX, startY, winningNumber, length){
        this.startX = startX;
        this.startY = startY;
        this.x = startX;
        this.y = startY;
        this.winningNumber = winningNumber;
        this.lengthOfWheel = length;
        this.symbols = ['🍒', '🍋', '🍊', '🍉', '🍇', '🍓', '⭐', '🔔', '🤠', '🤤'];
        this.roller = [];
        this.speed = 20;
        this.current = 0;

        this.init = function() {
          context.font = '100px Arial';
          for(var i = 0; i < this.lengthOfWheel; i++){
            this.roller.push(this.symbols[getRandomInt(this.symbols.length)]);
          };
          this.roller.push(this.symbols[this.winningNumber]);
          this.roller.push(this.symbols[1]);

        }

        this.reset = function() {
          this.roller = [];
          this.x = this.startX;
          this.y = this.startY;
          this.init();
        }

        this.update = function() {
          // Clear the specific slot area to avoid ghosting
          context.clearRect(this.x, 0, slotWidth, height);
          this.y = this.y + this.speed;

          //------------------------------------------
          const end = this.startY - slotHeight*this.lengthOfWheel;
          const start_slow = this.startY - slotHeight*(this.lengthOfWheel-10);

          if (this.current > (this.lengthOfWheel-5) && Math.floor((this.y-this.startY) / slotHeight )> Math.floor(this.current)){
            this.speed = Math.max(this.speed-20/5,0);
          }
          this.current = Math.floor((this.y-this.startY) / slotHeight);
          //------------------------------------------------

          for (var i = 0; i <= this.lengthOfWheel; i++) {
            context.fillText(this.roller[i], this.x, this.y - slotHeight * i);
          }
          
        }

        this.init();
      }


      function slotMachine(){
        this.slot1 = new slotColumn(slotWidth*3, 0, 2, 50);
        this.slot2 = new slotColumn(slotWidth*4, 0, 0, 65);
        this.slot3 = new slotColumn(slotWidth*5, 0, 1, 80);
        this.interval;

        this.reset = function() {
          context.clearRect(0,0, width, height);
          clearInterval(this.interval);
          this.slot1.reset();
          this.slot2.reset();
          this.slot3.reset();
        };

        this.spin = function() {
          // this.slot1.update();
          // this.slot2.update();
          // this.slot3.update();
          this.interval = setInterval(() => {
            this.slot1.update();
            this.slot2.update();
            this.slot3.update();
          }, 10);
        };
      };

      let slotmachine1 = new slotMachine();
      let slotmachine2 = new slotMachine();

      document.addEventListener('keydown', function(event) {
        if (event.code === 'Space'){
          //reset the screen when pressing
          slotmachine1.reset();
          slotmachine1.spin();
        } else if(event.code === 'ArrowUp'){
          slotmachine2.reset();
          slotmachine2.spin();
        };
      });
    </script>
  </body>
</html>
