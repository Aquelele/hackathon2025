<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Canvas Example</title>
  </head>
  <body>
    <div style="display: flex;">
    <canvas class="Player" id="Space"></canvas>
    <canvas class="Player" id="ArrowUp"></canvas>
    </div>
  <canvas id="myCanvas"></canvas>


    <script>
      const SLOTWIDTH = 150;
      const SLOTHEIGHT = 150;
      const SLOTSPACING = 25;
      const WIDTH = SLOTWIDTH*3 + SLOTSPACING*4;
      const HEIGHT = SLOTHEIGHT*4;
      const N_SLOW = 8; // how many fruits before stop
      const SPEED = 16;

      var audio = new Audio('click.mp3');
      

      p = document.querySelectorAll(".Player");
      machines = [];
      btns = [];
      p.forEach((canvas, index) => {
        context = canvas.getContext('2d');
        button = context.canvas.id;
        context.canvas.width  = WIDTH;
        context.canvas.height = HEIGHT;
        machines.push(new slotMachine(context, index*SLOTWIDTH));
        btns.push(button);
      });
      document.addEventListener('keydown', function(event) {
        let index = btns.indexOf(event.code);
        if (index !== -1) {
           //reset the screen when pressing
           machines[index].spin();
        }});

      function getRandomInt(max) {
          return Math.floor(Math.random() * max);
      }

      function statusLight(context, startX, startY, size) {
        this.x = startX;
        this.y = startY;
        this.size = size
        // 0 = green, 1 = red
        this.status = 0;

        context.fillStyle = 'green';
        context.fillRect(this.x, this.y, size, size);

        this.update = function() {
          context.clearRect(this.x, this.y, this.size, this.size);
          context.fillStyle = this.status === 0 ? 'green' : 'red';
          context.beginPath();
          context.arc(this.x, this.y, this.size/2, 0, 2 * Math.PI);
          context.fill();
        }
      }


      function slotColumn(context,startX, startY, winningNumber, length){
        this.context = context;
        this.startX = startX;
        this.startY = startY;
        this.winningNumber = winningNumber;
        this.lengthOfWheel = length;
        this.symbols = ['üçí', 'üçã', 'üçä', 'üçâ', 'üçá', 'üçì', '‚≠ê', 'üîî', 'ü§†', 'ü§§'];
        this.running = false;

        this.init = function() {
          this.roller = [];
          this.x = this.startX;
          this.y = this.startY;
          this.speed = SPEED;
          this.context.font = '100px Arial';
          for(let i = 0; i < this.lengthOfWheel; i++){
            this.roller.push(this.symbols[getRandomInt(this.symbols.length)]);
          };
          this.roller.push(this.symbols[this.winningNumber]);
          this.roller.push(this.symbols[getRandomInt(this.symbols.length)]);

        }

        this.update = function() {
          if (!this.running){
            return;
          }
          // Clear the specific slot area to avoid ghosting
          this.context.clearRect(this.x, 0, SLOTWIDTH, HEIGHT);
          this.y = this.y + this.speed;
          //slowdown effect
          const stop_const = Math.floor(this.y - this.startY - SLOTHEIGHT*((this.lengthOfWheel+1)-N_SLOW)-40);
          if (stop_const > 0 && stop_const < (N_SLOW+1)*SLOTHEIGHT){
            this.speed = Math.max( (1-Math.floor(stop_const/SLOTHEIGHT)/N_SLOW)*SPEED,0);
          }
          //spinning of wheel
          for (let i = 0; i < this.lengthOfWheel+2; i++) {
            if (this.y < SLOTHEIGHT*(2.5+i) && this.y >(i- 1)*SLOTHEIGHT){
              this.context.fillText(this.roller[i], this.x, this.y - SLOTHEIGHT * i);
            }
          }
          this.context.clearRect(this.x, 2*SLOTHEIGHT, SLOTWIDTH, SLOTHEIGHT);
          if (this.speed == 0) {
            this.running = false;
          }
        }
        
        this.spin = async function() {
          this.init();
          this.running = true;
        }

        this.init();
      }

      

      function slotMachine(context, placement){
        this.res = [2,0,1];
        this.slot1 = new slotColumn(context,placement, 0, this.res[0], 30);
        this.slot2 = new slotColumn(context,placement + SLOTWIDTH, 0, this.res[1], 45);
        this.slot3 = new slotColumn(context,placement + 2*SLOTWIDTH, 0, this.res[2], 60);
        // this.slot4 = new slotColumn(context,placement + 3*SLOTWIDTH, 0, this.res[2], 60);
        // this.slot5 = new slotColumn(context,placement + 4*SLOTWIDTH, 0, this.res[2], 60);
        this.cols = [this.slot1, this.slot2, this.slot3];
        this.interval;
        this.spinning = false;

        this.statusLight = new statusLight(context, placement + SLOTWIDTH*1.5, HEIGHT-250, 50);

        this.isDone = function() {
          return this.cols.every(slot => slot.speed === 0);
        };

        this.spin = async function() {  
          // Continuously check if all columns are done
          if (this.spinning === false){
            for (const item of this.cols) {
              this.statusLight.status = 1;
              item.spin(); 
              this.statusLight.update();
              
            }
          }
          let checkInterval = setInterval(() => {
            this.spinning = !this.isDone();
            if (this.isDone()) {
              this.statusLight.status = 0;
              this.statusLight.update();
              clearInterval(checkInterval);
              return this.res;
            }
          }, 50);
        };
        
        this.update = function() {
          this.slot1.update();
          this.slot2.update();
          this.slot3.update();
          this.statusLight.update();
        }
      };

      gameLoop = setInterval(() => {
        machines.forEach(machine => {
          machine.update();
        });  
      }, 10);



    </script>
  </body>
</html>
